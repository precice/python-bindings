name: Build and Test
on:
  push:
    branches:
      - master
      - develop
  pull_request:
    paths:
      - '**'
      
jobs:  
  setup_build_ext:
    name: build_ext
    runs-on: ubuntu-latest
    container: benjaminrueth/ci-precice-2004
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Install pip3
        run: |
          curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
          python3 get-pip.py
      - name: Install dependencies
        run: |
          pip3 install --user toml
          python3 -c 'import toml; c = toml.load("pyproject.toml"); print("\n".join(c["build-system"]["requires"]))' | pip3 install -r /dev/stdin
      - name: Run setup_py build_ext
        run:  python3 setup.py build_ext

  setup_install:
    name: setup_install
    runs-on: ubuntu-latest
    container: benjaminrueth/ci-precice-2004
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Install pip3
        run: |
          curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
          python3 get-pip.py
      - name: Install dependencies
        run: |
          pip3 install --user toml
          python3 -c 'import toml; c = toml.load("pyproject.toml"); print("\n".join(c["build-system"]["requires"]))' | pip3 install -r /dev/stdin
      - name: Run setup_py install
        run:  python3 setup.py install --user
      - name: Test install
        run:  python3 -c "import precice"
        
  setup_install_single_version_externally_managed:
    name: setup_install_single_version_externally_managed
    runs-on: ubuntu-latest
    container: benjaminrueth/ci-precice-2004
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Install pip3
        run: |
          curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
          python3 get-pip.py
      - name: Install dependencies
        run: |
          pip3 install --user toml
          python3 -c 'import toml; c = toml.load("pyproject.toml"); print("\n".join(c["build-system"]["requires"]))' | pip3 install -r /dev/stdin
      - name: Run setup_py install 
        run:  python3 setup.py install --single-version-externally-managed --root
        
  setup_test:
    name: setup_test
    runs-on: ubuntu-latest
    container: precice/ci-ubuntu-2004
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Checkout precice and make required files discoverable
        run: | 
          git clone https://github.com/precice/precice.git precice-core
          mkdir precice
          cp precice-core/src/precice/SolverInterface.hpp precice/SolverInterface.hpp
      - name: Install pip3
        run: |
          curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
          python3 get-pip.py
      - name: Install dependencies
        run: |
          pip3 install --user toml
          python3 -c 'import toml; c = toml.load("pyproject.toml"); print("\n".join(c["build-system"]["requires"]))' | pip3 install -r /dev/stdin
      - name: Run setup_py test
        run:  python3 setup.py test
        
  pip_install:
    name: pip_install
    runs-on: ubuntu-latest
    container: benjaminrueth/ci-precice-2004
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Install pip3
        run: |
          curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
          python3 get-pip.py
      - name: Run pip install
        run:  pip3 install --user .
      - name: Test install
        run:  python3 -c "import precice"

  solverdummy_test:
    name: solverdummy_test
    runs-on: ubuntu-latest
    container: benjaminrueth/ci-precice-2004
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Install pip3
        run: |
          curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
          python3 get-pip.py
      - name: Run pip install
        run:  pip3 install --user .
      - name: Test solverdummy
        run:  python3 solverdummy/solverdummy.py solverdummy/precice-config.xml SolverOne MeshOne & python3 solverdummy/solverdummy.py solverdummy/precice-config.xml SolverTwo MeshTwo
        
